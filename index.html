<!doctype html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <title>WebTransport Luiz - Persistent Stream</title>
        <style>
            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                padding: 30px;
                background: #1a1a1a;
                color: #eee;
            }
            .container {
                max-width: 600px;
                margin: auto;
                background: #2d2d2d;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            }
            input,
            button {
                width: 100%;
                padding: 12px;
                margin: 8px 0;
                border-radius: 4px;
                border: none;
                font-size: 16px;
            }
            input {
                background: #3d3d3d;
                color: white;
            }
            button {
                background: #007acc;
                color: white;
                cursor: pointer;
                font-weight: bold;
            }
            button:disabled {
                background: #555;
                cursor: not-allowed;
            }
            #log {
                background: #000;
                padding: 10px;
                border-radius: 4px;
                height: 200px;
                overflow-y: auto;
                font-family: monospace;
                font-size: 12px;
                color: #0f0;
                margin-top: 20px;
                border: 1px solid #444;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h2>WebTransport Tester</h2>

            <label>Fingerprint SHA-256 do Certificado:</label>
            <input
                type="text"
                id="hashInput"
                placeholder="Ex: e3b0c442... (64 caracteres hex)"
            />

            <button id="connectBtn">Conectar e Abrir Stream</button>
            <hr />
            <input
                type="text"
                id="messageInput"
                placeholder="Pressione 'w' ou digite algo..."
                disabled
            />
            <button id="sendBtn" disabled>Enviar via Stream Existente</button>

            <div id="log"></div>
        </div>

        <script>
            const logDiv = document.getElementById("log");
            const hashInput = document.getElementById("hashInput");
            const connectBtn = document.getElementById("connectBtn");
            const sendBtn = document.getElementById("sendBtn");
            const messageInput = document.getElementById("messageInput");

            let transport;
            let writer; // Persistente
            let reader; // Persistente

            function log(msg) {
                const p = document.createElement("div");
                p.textContent = `> ${msg}`;
                logDiv.appendChild(p);
                logDiv.scrollTop = logDiv.scrollHeight;
            }

            function hexToBytes(hex) {
                hex = hex.replace(/\s|:/g, "");
                let bytes = new Uint8Array(hex.length / 2);
                for (let i = 0; i < bytes.length; i++) {
                    bytes[i] = parseInt(hex.substr(i * 2, 2), 16);
                }
                return bytes;
            }

            // Função para ler o eco do servidor continuamente
            async function readFromRust() {
                const decoder = new TextDecoder();
                try {
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) {
                            log("Stream de leitura fechada pelo servidor.");
                            break;
                        }
                        log(`Eco do Rust: ${decoder.decode(value)}`);
                    }
                } catch (e) {
                    log(`Erro na leitura: ${e}`);
                }
            }

            connectBtn.onclick = async () => {
                const hashHex = hashInput.value.trim();
                if (hashHex.length !== 64) {
                    log("Erro: A hash SHA-256 deve ter 64 caracteres hex.");
                    return;
                }

                try {
                    const fingerprint = hexToBytes(hashHex);

                    transport = new WebTransport("https://127.0.0.1:4433", {
                        serverCertificateHashes: [
                            { algorithm: "sha-256", value: fingerprint },
                        ],
                    });

                    log("Conectando...");
                    await transport.ready;
                    log("Conectado ao servidor!");

                    // CRIANDO A STREAM PERSISTENTE AQUI
                    const stream = await transport.createBidirectionalStream();
                    writer = stream.writable.getWriter();
                    reader = stream.readable.getReader();

                    // Inicia o loop de leitura em "background"
                    readFromRust();

                    connectBtn.disabled = true;
                    sendBtn.disabled = false;
                    messageInput.disabled = false;

                    log("Stream aberta e pronta para uso contínuo.");
                } catch (e) {
                    log(`Erro na conexão: ${e}`);
                }
            };

            async function sendMessage(msg) {
                if (!writer) return;
                const encoder = new TextEncoder();
                await writer.write(encoder.encode(msg));
                log(`Enviado: ${msg}`);
            }

            sendBtn.onclick = () => {
                sendMessage(messageInput.value);
                messageInput.value = "";
            };

            // Atalho: apertar Enter também envia
            messageInput.onkeydown = (e) => {
                if (e.key === "Enter") {
                    sendMessage(messageInput.value);
                    messageInput.value = "";
                }
            };
        </script>
    </body>
</html>
